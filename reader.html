<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优雅Markdown阅读器</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 日间模式颜色
                        day: {
                            bg: '#f8fafc',
                            text: '#1e293b',
                            lightText: '#334155',
                            card: '#ffffff',
                            border: '#e2e8f0'
                        },
                        // 护眼模式颜色
                        eye: {
                            bg: '#f2fbf1',
                            text: '#2c3e50',
                            lightText: '#34495e',
                            card: '#ffffff',
                            border: '#d5e8d4'
                        },
                        // 夜间模式颜色
                        night: {
                            bg: '#0f172a',
                            text: '#e2e8f0',
                            lightText: '#cbd5e1',
                            card: '#1e293b',
                            border: '#334155'
                        },
                        primary: '#4f46e5' // 主色调：深紫色
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Georgia', 'Cambria', 'serif'],
                        mono: ['Consolas', 'Monaco', 'monospace']
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-balance {
                text-wrap: balance;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .chapter-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            }
        }
    </style>
    
    <style>
        /* 基础动画定义 */
        .fade-in {
            animation: fadeIn 0.4s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .slide-out-right {
            animation: slideOutRight 0.3s ease-in forwards;
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 阅读区域自定义滚动条 */
        .reading-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .reading-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .reading-area::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.2);
            border-radius: 3px;
        }
        
        .reading-area::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.4);
        }
        
        /* 章节列表滚动条 */
        .chapter-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .chapter-list::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.3);
            border-radius: 2px;
        }
        
        /* Markdown样式增强 */
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3, 
        .markdown-content h4 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
        }
        
        .markdown-content h1 { font-size: 1.8em; }
        .markdown-content h2 { font-size: 1.5em; }
        .markdown-content h3 { font-size: 1.3em; }
        .markdown-content h4 { font-size: 1.1em; }
        
        .markdown-content p {
            margin-bottom: 1em;
            line-height: 1.8;
        }
        
        .markdown-content ul, 
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        
        .markdown-content li {
            margin-bottom: 0.5em;
            line-height: 1.6;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid rgba(79, 70, 229, 0.5);
            padding-left: 1em;
            margin-left: 0;
            margin-bottom: 1em;
            font-style: italic;
        }
        
        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .markdown-content code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        
        .markdown-content a {
            color: #4f46e5;
            text-decoration: underline;
            text-underline-offset: 2px;
        }
        
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1.5em 0;
        }
    </style>
</head>
<body class="theme-day font-sans min-h-screen flex flex-col overflow-hidden">
    <!-- 主题相关样式类定义 -->
    <style>
        /* 日间模式 */
        .theme-day {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --light-text-color: #334155;
            --card-color: #ffffff;
            --border-color: #e2e8f0;
        }
        
        .theme-day .bg-theme { background-color: var(--bg-color); }
        .theme-day .text-theme { color: var(--text-color); }
        .theme-day .text-theme-light { color: var(--light-text-color); }
        .theme-day .bg-card { background-color: var(--card-color); }
        .theme-day .border-theme { border-color: var(--border-color); }
        
        /* 护眼模式 */
        .theme-eye {
            --bg-color: #f2fbf1;
            --text-color: #2c3e50;
            --light-text-color: #34495e;
            --card-color: #ffffff;
            --border-color: #d5e8d4;
        }
        
        .theme-eye .bg-theme { background-color: var(--bg-color); }
        .theme-eye .text-theme { color: var(--text-color); }
        .theme-eye .text-theme-light { color: var(--light-text-color); }
        .theme-eye .bg-card { background-color: var(--card-color); }
        .theme-eye .border-theme { border-color: var(--border-color); }
        
        /* 夜间模式 */
        .theme-night {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --light-text-color: #cbd5e1;
            --card-color: #1e293b;
            --border-color: #334155;
        }
        
        .theme-night .bg-theme { background-color: var(--bg-color); }
        .theme-night .text-theme { color: var(--text-color); }
        .theme-night .text-theme-light { color: var(--light-text-color); }
        .theme-night .bg-card { background-color: var(--card-color); }
        .theme-night .border-theme { border-color: var(--border-color); }
        
        /* 夜间模式下的特殊样式 */
        .theme-night .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.2);
        }
    </style>
    
    <!-- 顶部控制栏 -->
    <header id="top-bar" class="fixed top-0 left-0 right-0 bg-card/80 backdrop-blur z-30 py-3 px-4 md:px-6 transition-all duration-300 shadow-sm border-b border-theme">
        <div class="container mx-auto flex justify-between items-center">
            <!-- 当前章节标题 -->
            <h1 id="current-chapter-title" class="text-lg md:text-xl font-medium text-theme truncate max-w-[50%]">
                加载中...
            </h1>
            
            <!-- 控制按钮组 -->
            <div class="flex items-center space-x-4">
                <!-- 主题切换按钮 -->
                <div class="relative group">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-theme/50 transition-colors text-theme" aria-label="切换主题">
                        <i class="fa fa-moon-o"></i>
                    </button>
                    
                    <!-- 主题选择下拉菜单 -->
                    <div id="theme-dropdown" class="absolute right-0 mt-2 w-36 bg-card rounded-lg shadow-lg border border-theme overflow-hidden z-50 hidden group-hover:block">
                        <button class="theme-option w-full text-left px-4 py-2 hover:bg-theme/30 transition-colors flex items-center" data-theme="day">
                            <i class="fa fa-sun-o mr-2"></i>
                            <span>日间模式</span>
                        </button>
                        <button class="theme-option w-full text-left px-4 py-2 hover:bg-theme/30 transition-colors flex items-center" data-theme="eye">
                            <i class="fa fa-leaf mr-2"></i>
                            <span>护眼模式</span>
                        </button>
                        <button class="theme-option w-full text-left px-4 py-2 hover:bg-theme/30 transition-colors flex items-center" data-theme="night">
                            <i class="fa fa-moon-o mr-2"></i>
                            <span>夜间模式</span>
                        </button>
                    </div>
                </div>
                
                <!-- 字体大小调节按钮 -->
                <button id="font-size-toggle" class="p-2 rounded-full hover:bg-theme/50 transition-colors text-theme" aria-label="调节字体大小">
                    <i class="fa fa-text-height"></i>
                </button>
                
                <!-- 目录按钮 -->
                <button id="toc-toggle" class="p-2 rounded-full hover:bg-theme/50 transition-colors text-theme lg:hidden" aria-label="显示目录">
                    <i class="fa fa-list"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- 主内容区 -->
    <main class="flex-1 flex overflow-hidden pt-14">
        <!-- 阅读区域 -->
        <div class="flex-1 overflow-y-auto reading-area p-4 md:p-8 lg:p-12 relative bg-theme">
            <!-- 点击遮罩 - 用于唤出章节选择器 -->
            <div id="tap-overlay" class="absolute inset-0 z-10 opacity-0 cursor-default" aria-hidden="true">
                <!-- 中央提示点 -->
                <div class="absolute left-1/2 top-1/2 w-4 h-4 rounded-full bg-primary/30 pulse -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
            </div>
            
            <!-- 文章容器 -->
            <div class="max-w-3xl mx-auto">
                <!-- 文章标题 -->
                <h2 id="passage-title" class="text-2xl md:text-3xl font-bold text-theme mb-8 text-center"></h2>
                
                <!-- 文章内容 -->
                <div id="passage-content" class="markdown-content max-w-none mx-auto text-theme-light leading-relaxed">
                    <div class="flex flex-col justify-center items-center h-64">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-4"></div>
                        <p class="text-theme-light">正在加载文章内容...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 章节侧边栏 -->
        <aside id="chapter-sidebar" class="w-72 bg-card shadow-lg z-20 transform translate-x-full fixed lg:static lg:translate-x-0 h-[calc(100vh-3.5rem)] overflow-hidden flex flex-col transition-transform duration-300 border-l border-theme">
            <!-- 侧边栏标题 -->
            <div class="p-4 border-b border-theme flex justify-between items-center">
                <h3 class="font-semibold text-theme">章节列表</h3>
                <button id="close-sidebar" class="p-1.5 rounded hover:bg-theme/50 transition-colors text-theme-light lg:hidden">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 章节搜索 -->
            <div class="p-3 border-b border-theme">
                <div class="relative">
                    <input type="text" id="chapter-search" placeholder="搜索章节..." 
                           class="w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-theme bg-theme/50 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-theme">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-theme-light"></i>
                </div>
            </div>
            
            <!-- 章节列表 -->
            <div class="flex-1 overflow-y-auto chapter-list p-2">
                <ul id="chapters-container" class="space-y-1">
                    <!-- 章节列表将通过JavaScript动态生成 -->
                    <li class="p-3 text-center text-theme-light">
                        <div class="inline-block animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-primary mb-2"></div>
                        <p class="text-sm">加载章节列表中...</p>
                    </li>
                </ul>
            </div>
        </aside>
    </main>
    
    <!-- 底部控制栏 -->
    <footer class="bg-card/80 backdrop-blur py-3 px-4 border-t border-theme z-30">
        <div class="container mx-auto flex justify-between items-center">
            <!-- 上一章按钮 -->
            <button id="prev-chapter" class="flex items-center space-x-1 px-3 py-1.5 rounded-lg hover:bg-theme/50 transition-colors text-theme-light disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa fa-chevron-left"></i>
                <span>上一章</span>
            </button>
            
            <!-- 章节进度 -->
            <div class="hidden md:flex items-center space-x-2">
                <span id="chapter-progress" class="text-sm text-theme-light">1/0</span>
                <div class="w-32 h-1.5 bg-theme rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-primary rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- 下一章按钮 -->
            <button id="next-chapter" class="flex items-center space-x-1 px-3 py-1.5 rounded-lg hover:bg-theme/50 transition-colors text-theme-light disabled:opacity-50 disabled:cursor-not-allowed">
                <span>下一章</span>
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
    </footer>
    
    <!-- 字体大小调节面板 -->
    <div id="font-size-panel" class="fixed bottom-20 right-6 bg-card rounded-xl shadow-lg p-4 z-40 hidden fade-in w-48 border border-theme">
        <h4 class="font-medium text-theme mb-3 flex items-center">
            <i class="fa fa-text-height mr-2 text-primary"></i>
            字体大小
        </h4>
        <div class="space-y-3">
            <!-- 字体大小滑块 -->
            <input type="range" id="font-size-slider" min="14" max="24" step="1" value="18" 
                   class="w-full h-2 bg-theme rounded-lg appearance-none cursor-pointer accent-primary">
            
            <!-- 预设按钮 -->
            <div class="flex justify-between">
                <button class="font-size-preset text-xs px-2 py-1 rounded hover:bg-theme/50 transition-colors text-theme-light" data-size="14">小</button>
                <button class="font-size-preset text-sm px-2 py-1 rounded hover:bg-theme/50 transition-colors text-theme-light" data-size="16">中</button>
                <button class="font-size-preset text-base px-2 py-1 rounded hover:bg-theme/50 transition-colors text-theme-light" data-size="18">标准</button>
                <button class="font-size-preset text-lg px-2 py-1 rounded hover:bg-theme/50 transition-colors text-theme-light" data-size="20">大</button>
                <button class="font-size-preset text-xl px-2 py-1 rounded hover:bg-theme/50 transition-colors text-theme-light" data-size="24">特大</button>
            </div>
        </div>
    </div>
    
    <!-- 章节选择浮动面板 -->
    <div id="chapter-float-panel" class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur-sm hidden">
        <div class="bg-card rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden chapter-shadow fade-in border border-theme">
            <!-- 面板标题 -->
            <div class="p-4 border-b border-theme flex justify-between items-center">
                <h3 class="font-semibold text-theme">选择章节</h3>
                <button id="close-float-panel" class="p-1.5 rounded hover:bg-theme/50 transition-colors text-theme-light">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 搜索框 -->
            <div class="p-3 border-b border-theme">
                <div class="relative">
                    <input type="text" id="float-chapter-search" placeholder="搜索章节..." 
                           class="w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-theme bg-theme/50 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-theme">
                    <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-theme-light"></i>
                </div>
            </div>
            
            <!-- 章节列表 -->
            <div class="max-h-[calc(80vh-120px)] overflow-y-auto chapter-list p-2">
                <ul id="float-chapters-container" class="space-y-1">
                    <!-- 章节列表将通过JavaScript动态生成 -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 阅读器核心功能实现
        document.addEventListener('DOMContentLoaded', () => {
            // DOM元素引用
            const passageTitle = document.getElementById('passage-title');
            const passageContent = document.getElementById('passage-content');
            const currentChapterTitle = document.getElementById('current-chapter-title');
            const chaptersContainer = document.getElementById('chapters-container');
            const floatChaptersContainer = document.getElementById('float-chapters-container');
            const prevChapterBtn = document.getElementById('prev-chapter');
            const nextChapterBtn = document.getElementById('next-chapter');
            const chapterProgress = document.getElementById('chapter-progress');
            const progressBar = document.getElementById('progress-bar');
            const chapterSidebar = document.getElementById('chapter-sidebar');
            const tocToggle = document.getElementById('toc-toggle');
            const closeSidebar = document.getElementById('close-sidebar');
            const tapOverlay = document.getElementById('tap-overlay');
            const chapterFloatPanel = document.getElementById('chapter-float-panel');
            const closeFloatPanel = document.getElementById('close-float-panel');
            const fontsizeToggle = document.getElementById('font-size-toggle');
            const fontsizePanel = document.getElementById('font-size-panel');
            const fontsizeSlider = document.getElementById('font-size-slider');
            const fontsizePresets = document.querySelectorAll('.font-size-preset');
            const chapterSearch = document.getElementById('chapter-search');
            const floatChapterSearch = document.getElementById('float-chapter-search');
            const themeToggle = document.getElementById('theme-toggle');
            const themeDropdown = document.getElementById('theme-dropdown');
            const themeOptions = document.querySelectorAll('.theme-option');
            
            // 阅读器状态
            let chapters = [];          // 章节列表
            let currentChapterIndex = 0;// 当前章节索引
            let fontSize = 18;          // 默认字体大小(px)
            let currentTheme = 'day';   // 默认主题
            
            // 初始化阅读器
            initReader();
            
            // 初始化函数
            async function initReader() {
                try {
                    // 加载用户偏好设置
                    loadUserPreferences();
                    
                    // 获取章节列表 - 实际应用中应该从服务器获取文件列表
                    chapters = await getChapterList();
                    
                    // 渲染章节列表
                    renderChapterLists();
                    
                    // 加载第一章
                    if (chapters.length > 0) {
                        loadChapter(0);
                    }
                    
                    // 绑定事件监听
                    bindEvents();
                    
                } catch (error) {
                    console.error('初始化阅读器失败:', error);
                    passageContent.innerHTML = `<div class="text-center text-theme-light py-10"><i class="fa fa-exclamation-triangle text-amber-500 text-2xl mb-3"></i><p>加载失败，请刷新页面重试</p></div>`;
                }
            }
            
            // 获取章节列表 - 实际应用中应从服务器API获取
            async function getChapterList() {
                // 这里模拟获取章节列表，实际应用中应该是一个API请求
                // 获取static/passage目录下的.md文件列表，文件命名格式为"数字+中文章节名.md"
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve([
                            { id: 1, title: "第一章：启程", filename: "1第一章：启程.md" },
                            { id: 2, title: "第二章：相遇", filename: "2第二章：相遇.md" },
                            { id: 3, title: "第三章：探索", filename: "3第三章：探索.md" },
                            { id: 4, title: "第四章：挑战", filename: "4第四章：挑战.md" },
                            { id: 5, title: "第五章：成长", filename: "5第五章：成长.md" },
                            { id: 6, title: "第六章：秘密", filename: "6第六章：秘密.md" },
                            { id: 7, title: "第七章：抉择", filename: "7第七章：抉择.md" },
                            { id: 8, title: "第八章：归途", filename: "8第八章：归途.md" }
                        ]);
                    }, 800); // 模拟网络延迟
                });
            }
            
            // 加载章节内容
            async function loadChapter(index) {
                if (index < 0 || index >= chapters.length) return;
                
                // 更新当前章节索引
                currentChapterIndex = index;
                const chapter = chapters[index];
                
                // 显示加载状态
                passageContent.innerHTML = `<div class="flex justify-center items-center h-64"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-4"></div><p class="text-theme-light">加载中...</p></div>`;
                
                try {
                    // 加载Markdown章节内容
                    // 实际路径应为`static/passage/${chapter.filename}`
                    const mdContent = await getChapterContent(chapter.filename);
                    
                    // 将Markdown转换为HTML
                    const htmlContent = marked.parse(mdContent);
                    
                    // 更新UI
                    currentChapterTitle.textContent = chapter.title;
                    passageTitle.textContent = chapter.title;
                    passageContent.innerHTML = htmlContent;
                    
                    // 应用当前字体大小
                    setFontSize(fontSize, false);
                    
                    // 更新章节进度
                    updateChapterProgress();
                    
                    // 更新章节选中状态
                    updateChapterSelection();
                    
                    // 滚动到顶部
                    document.querySelector('.reading-area').scrollTop = 0;
                    
                } catch (error) {
                    console.error(`加载章节 ${chapter.title} 失败:`, error);
                    passageContent.innerHTML = `<div class="text-center text-theme-light py-10"><i class="fa fa-exclamation-triangle text-amber-500 text-2xl mb-3"></i><p>章节加载失败</p></div>`;
                }
            }
            
            // 获取章节内容 - 实际应用中应从服务器获取
            async function getChapterContent(filename) {
                // 实际应用中，这里应该是一个API请求，获取对应.md文件的内容
                // 实际路径应为`static/passage/${filename}`
                return new Promise(resolve => {
                    setTimeout(() => {
                        // 生成模拟的Markdown内容
                        const content = `# ${filename.replace(/\d+|\.md/g, '')}

这是一个示例章节，使用Markdown格式编写。

## 二级标题

- 列表项1
- 列表项2
- 列表项3

> 这是一段引用文本，展示Markdown的引用格式。

### 三级标题

这是一段普通文本，包含**加粗内容**和*斜体内容*。

\`\`\`javascript
// 代码块示例
function greet() {
    console.log("Hello, World!");
}
\`\`\`

图片示例：
![示例图片](https://picsum.photos/800/400)

[链接示例](https://example.com)
`;
                        resolve(content);
                    }, 600); // 模拟网络延迟
                });
            }
            
            // 渲染章节列表（侧边栏和浮动面板）
            function renderChapterLists() {
                if (chapters.length === 0) {
                    chaptersContainer.innerHTML = '<li class="p-3 text-center text-theme-light text-sm">没有找到章节</li>';
                    floatChaptersContainer.innerHTML = '<li class="p-3 text-center text-theme-light text-sm">没有找到章节</li>';
                    return;
                }
                
                // 清空容器
                chaptersContainer.innerHTML = '';
                floatChaptersContainer.innerHTML = '';
                
                // 生成章节列表项
                chapters.forEach((chapter, index) => {
                    // 创建侧边栏章节项
                    const sidebarItem = document.createElement('li');
                    sidebarItem.className = `chapter-item px-3 py-2 rounded-lg text-sm cursor-pointer transition-colors ${index === currentChapterIndex ? 'bg-primary/10 text-primary font-medium' : 'hover:bg-theme/50 text-theme-light'}`;
                    sidebarItem.textContent = chapter.title;
                    sidebarItem.dataset.index = index;
                    chaptersContainer.appendChild(sidebarItem);
                    
                    // 创建浮动面板章节项
                    const floatItem = sidebarItem.cloneNode(true);
                    floatChaptersContainer.appendChild(floatItem);
                });
            }
            
            // 更新章节选中状态
            function updateChapterSelection() {
                // 更新侧边栏选中状态
                document.querySelectorAll('#chapters-container .chapter-item').forEach((item, index) => {
                    if (index === currentChapterIndex) {
                        item.classList.add('bg-primary/10', 'text-primary', 'font-medium');
                        item.classList.remove('hover:bg-theme/50', 'text-theme-light');
                    } else {
                        item.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
                        item.classList.add('hover:bg-theme/50', 'text-theme-light');
                    }
                });
                
                // 更新浮动面板选中状态
                document.querySelectorAll('#float-chapters-container .chapter-item').forEach((item, index) => {
                    if (index === currentChapterIndex) {
                        item.classList.add('bg-primary/10', 'text-primary', 'font-medium');
                        item.classList.remove('hover:bg-theme/50', 'text-theme-light');
                    } else {
                        item.classList.remove('bg-primary/10', 'text-primary', 'font-medium');
                        item.classList.add('hover:bg-theme/50', 'text-theme-light');
                    }
                });
            }
            
            // 更新章节进度
            function updateChapterProgress() {
                const progress = ((currentChapterIndex + 1) / chapters.length) * 100;
                progressBar.style.width = `${progress}%`;
                chapterProgress.textContent = `${currentChapterIndex + 1}/${chapters.length}`;
                
                // 更新导航按钮状态
                prevChapterBtn.disabled = currentChapterIndex === 0;
                nextChapterBtn.disabled = currentChapterIndex === chapters.length - 1;
            }
            
            // 切换字体大小
            function setFontSize(size, save = true) {
                fontSize = size;
                fontsizeSlider.value = size;
                passageContent.style.fontSize = `${size}px`;
                
                // 保存用户偏好
                if (save) {
                    localStorage.setItem('readerFontSize', size);
                }
            }
            
            // 切换主题
            function setTheme(theme) {
                // 移除当前主题类
                document.body.classList.remove(`theme-${currentTheme}`);
                
                // 设置新主题
                currentTheme = theme;
                document.body.classList.add(`theme-${currentTheme}`);
                
                // 更新主题图标
                const themeIcon = themeToggle.querySelector('i');
                themeIcon.className = '';
                switch(theme) {
                    case 'day':
                        themeIcon.className = 'fa fa-sun-o';
                        break;
                    case 'eye':
                        themeIcon.className = 'fa fa-leaf';
                        break;
                    case 'night':
                        themeIcon.className = 'fa fa-moon-o';
                        break;
                }
                
                // 保存用户偏好
                localStorage.setItem('readerTheme', theme);
            }
            
            // 搜索章节
            function searchChapters(query, containerId) {
                const container = document.getElementById(containerId);
                const items = container.querySelectorAll('.chapter-item');
                
                query = query.toLowerCase().trim();
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(query)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            // 从本地存储加载用户偏好设置
            function loadUserPreferences() {
                // 加载字体大小偏好
                const savedFontSize = localStorage.getItem('readerFontSize');
                if (savedFontSize) {
                    setFontSize(parseInt(savedFontSize), false);
                }
                
                // 加载主题偏好
                const savedTheme = localStorage.getItem('readerTheme');
                if (savedTheme) {
                    setTheme(savedTheme);
                } else {
                    // 默认使用日间模式
                    setTheme('day');
                }
            }
            
            // 绑定事件监听
            function bindEvents() {
                // 上一章按钮
                prevChapterBtn.addEventListener('click', () => {
                    if (currentChapterIndex > 0) {
                        loadChapter(currentChapterIndex - 1);
                    }
                });
                
                // 下一章按钮
                nextChapterBtn.addEventListener('click', () => {
                    if (currentChapterIndex < chapters.length - 1) {
                        loadChapter(currentChapterIndex + 1);
                    }
                });
                
                // 侧边栏章节点击
                chaptersContainer.addEventListener('click', (e) => {
                    const chapterItem = e.target.closest('.chapter-item');
                    if (chapterItem) {
                        const index = parseInt(chapterItem.dataset.index);
                        loadChapter(index);
                        
                        // 在移动设备上自动关闭侧边栏
                        if (window.innerWidth < 1024) {
                            toggleSidebar(false);
                        }
                    }
                });
                
                // 浮动面板章节点击
                floatChaptersContainer.addEventListener('click', (e) => {
                    const chapterItem = e.target.closest('.chapter-item');
                    if (chapterItem) {
                        const index = parseInt(chapterItem.dataset.index);
                        loadChapter(index);
                        toggleChapterFloatPanel(false);
                    }
                });
                
                // 侧边栏切换
                tocToggle.addEventListener('click', () => toggleSidebar());
                closeSidebar.addEventListener('click', () => toggleSidebar(false));
                
                // 点击阅读区域中央显示章节选择面板
                tapOverlay.addEventListener('click', (e) => {
                    // 只在点击中央区域时响应
                    const rect = tapOverlay.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const clickX = e.clientX - rect.left;
                    const clickY = e.clientY - rect.top;
                    
                    // 计算点击位置与中心的距离
                    const distance = Math.sqrt(Math.pow(clickX - centerX, 2) + Math.pow(clickY - centerY, 2));
                    
                    // 如果在中心区域（半径为100px的圆内）
                    if (distance < 100) {
                        toggleChapterFloatPanel();
                    }
                });
                
                // 关闭浮动面板
                closeFloatPanel.addEventListener('click', () => toggleChapterFloatPanel(false));
                
                // 点击浮动面板背景关闭
                chapterFloatPanel.addEventListener('click', (e) => {
                    if (e.target === chapterFloatPanel) {
                        toggleChapterFloatPanel(false);
                    }
                });
                
                // 字体大小面板切换
                fontsizeToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fontsizePanel.classList.toggle('hidden');
                });
                
                // 点击页面其他地方关闭字体面板
                document.addEventListener('click', (e) => {
                    if (!fontsizePanel.contains(e.target) && e.target !== fontsizeToggle) {
                        fontsizePanel.classList.add('hidden');
                    }
                });
                
                // 字体大小滑块
                fontsizeSlider.addEventListener('input', (e) => {
                    setFontSize(parseInt(e.target.value));
                });
                
                // 字体大小预设按钮
                fontsizePresets.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const size = parseInt(btn.dataset.size);
                        setFontSize(size);
                    });
                });
                
                // 章节搜索
                chapterSearch.addEventListener('input', (e) => {
                    searchChapters(e.target.value, 'chapters-container');
                });
                
                floatChapterSearch.addEventListener('input', (e) => {
                    searchChapters(e.target.value, 'float-chapters-container');
                });
                
                // 主题切换
                themeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        setTheme(theme);
                        themeDropdown.classList.add('hidden');
                    });
                });
                
                // 点击其他地方关闭主题下拉菜单
                document.addEventListener('click', (e) => {
                    if (!themeDropdown.contains(e.target) && e.target !== themeToggle) {
                        themeDropdown.classList.add('hidden');
                    }
                });
                
                // 主题按钮点击切换下拉菜单
                themeToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    themeDropdown.classList.toggle('hidden');
                });
                
                // 窗口大小变化时处理侧边栏
                window.addEventListener('resize', () => {
                    if (window.innerWidth >= 1024) {
                        // 在大屏幕上始终显示侧边栏
                        chapterSidebar.classList.remove('translate-x-full', 'slide-out-right', 'slide-in-right');
                    } else if (!chapterSidebar.classList.contains('translate-x-full')) {
                        // 在小屏幕上如果侧边栏是打开的，添加适当的类
                        chapterSidebar.classList.remove('slide-out-right');
                        chapterSidebar.classList.add('slide-in-right');
                    }
                });
                
                // 键盘导航
                document.addEventListener('keydown', (e) => {
                    // 左右箭头键导航章节
                    if (e.key === 'ArrowLeft') {
                        if (currentChapterIndex > 0) {
                            loadChapter(currentChapterIndex - 1);
                        }
                    } else if (e.key === 'ArrowRight') {
                        if (currentChapterIndex < chapters.length - 1) {
                            loadChapter(currentChapterIndex + 1);
                        }
                    }
                    // ESC键关闭面板
                    else if (e.key === 'Escape') {
                        fontsizePanel.classList.add('hidden');
                        themeDropdown.classList.add('hidden');
                        toggleChapterFloatPanel(false);
                        if (window.innerWidth < 1024) {
                            toggleSidebar(false);
                        }
                    }
                });
            }
            
            // 切换侧边栏显示状态
            function toggleSidebar(show) {
                const isVisible = !chapterSidebar.classList.contains('translate-x-full') && 
                                 !chapterSidebar.classList.contains('slide-out-right');
                
                // 如果指定了显示状态，使用指定的状态；否则切换
                const shouldShow = show !== undefined ? show : !isVisible;
                
                if (shouldShow) {
                    chapterSidebar.classList.remove('translate-x-full', 'slide-out-right');
                    chapterSidebar.classList.add('slide-in-right');
                } else {
                    chapterSidebar.classList.remove('slide-in-right');
                    chapterSidebar.classList.add('slide-out-right');
                    setTimeout(() => {
                        chapterSidebar.classList.add('translate-x-full');
                    }, 300);
                }
            }
            
            // 切换章节浮动面板显示状态
            function toggleChapterFloatPanel(show) {
                const isVisible = !chapterFloatPanel.classList.contains('hidden');
                const shouldShow = show !== undefined ? show : !isVisible;
                
                if (shouldShow) {
                    chapterFloatPanel.classList.remove('hidden');
                    // 同步搜索框内容
                    floatChapterSearch.value = chapterSearch.value;
                    searchChapters(floatChapterSearch.value, 'float-chapters-container');
                } else {
                    chapterFloatPanel.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
    